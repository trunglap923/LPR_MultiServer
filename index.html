<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo Vehicle Detection</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    nav { background: #222; color: white; padding: 10px; }
    nav button { margin-right: 10px; padding: 8px; cursor: pointer; }
    #content > div { display: none; padding: 10px; }
    #content > .active { display: block; }
    #log-list { max-height: 400px; overflow-y: auto; background: #eee; padding: 10px; }
    .log-img { width: 320px; display: block; margin: 5px 0; border: 1px solid #ccc; }
  </style>
</head>
<body>

<nav>
  <button onclick="showTab('live')">ğŸ”´ Live Video</button>
  <button onclick="showTab('search')">ğŸ” Tra cá»©u biá»ƒn sá»‘</button>
</nav>

<div id="content">
  <!-- LIVE VIDEO -->
  <div id="live">
    <h2>Live Video</h2>
    <img id="live-video" src="" style="width: 80%;" />
    <h3>Detection Log</h3>
    <div id="log-list"></div>
  </div>

  <!-- TRA Cá»¨U BIá»‚N Sá» -->
  <div id="search">
    <h2>Tra cá»©u biá»ƒn sá»‘</h2>
    <input type="text" id="plate-input" placeholder="Nháº­p biá»ƒn sá»‘" />
    <button onclick="searchPlate()">TÃ¬m kiáº¿m</button>
    <div id="search-results"></div>
  </div>
</div>

<script>

let clientSocket = null;

function showTab(tabId) {
  document.querySelectorAll("#content > div").forEach(div => {
    div.classList.remove("active");
  });
  document.getElementById(tabId).classList.add("active");

  if (tabId === "live") {
    startLiveView();
  } else {
    stopLiveView();
  }
}

function startLiveView() {
    if (!clientSocket || clientSocket.readyState !== WebSocket.OPEN) {
        if (clientSocket) {
            clientSocket.close();
        }

        clientSocket = new WebSocket("ws://localhost:8000/ws/client");

        clientSocket.onopen = () => {
            console.log("ğŸš€ WebSocket Ä‘Ã£ káº¿t ná»‘i tá»›i ws/client");
        };

        clientSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("ğŸ“¦ Nháº­n dá»¯ liá»‡u tá»« server:", data);

            const vehicleDict = {
              2: "Car",
              3: "Motorbike",
              5: "Bus",
              7: "Truck"
            };

            data.objects.forEach(o => {
              o.vehicle_class = vehicleDict[o.vehicle_class] || `Unknown (${o.vehicle_class})`;
            });
      
            const imageBlob = new Blob([new Uint8Array(atob(data.image_data).split("").map(c => c.charCodeAt(0)))], { type: "image/jpeg" });
            const imageUrl = URL.createObjectURL(imageBlob);
            const imgElement = document.getElementById("live-video");
            imgElement.src = imageUrl;
      
            const logList = document.getElementById("log-list");
            const div = document.createElement("div");
          
            const objectsInfo = data.objects.map(o => 
              `ID: ${o.tracking_id} | ${o.vehicle_class} | ${o.plate_number || "â›”"}`
            ).join(" | ");
      
            const date = new Date(data.timestamp);
            const timeStr = date.toLocaleTimeString('vi-VN', { hour12: false });
            const ms = String(date.getMilliseconds()).padStart(3, '0');
            const formatted = `${timeStr}.${ms}`;

            div.innerHTML = `
              <strong>ğŸ“¦ Frame ${data.frame_id}</strong> | ${formatted}<br/>
              ${objectsInfo}
            `;
            logList.prepend(div);
        };
    };
}

function stopLiveView() {
  if (clientSocket) {
    clientSocket.close();
    clientSocket = null;
  }
  document.getElementById("live-video").src = "";
  document.getElementById("log-list").innerHTML = "";
}

function searchPlate() {
  const plate = document.getElementById("plate-input").value;
  if (!plate) return;

  fetch(`http://localhost:8000/search_plate?plate=${encodeURIComponent(plate)}`)
    .then(res => res.json())
    .then(results => {
      const container = document.getElementById("search-results");
      container.innerHTML = "<h3>Káº¿t quáº£ tÃ¬m kiáº¿m:</h3>";
      
      if (results.length === 0) {
        container.innerHTML += "<p>KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£.</p>";
        return;
      }
      console.log("ğŸ“¦ Káº¿t quáº£ tÃ¬m kiáº¿m:", results);

      const vehicleDict = {
        2: "Car",
        3: "Motorbike",
        5: "Bus",
        7: "Truck"
      };

      results.forEach(item => {
        const div = document.createElement("div");
        const timeStr = new Date(item.timestamp).toLocaleString("vi-VN");

        const vehicleType = vehicleDict[item.vehicle_class] || `Unknown (${item.vehicle_class})`;

        div.innerHTML = `
          <strong>ğŸ“¸ Frame ${item.frame_id} - ${timeStr}</strong><br/>
          ğŸ”¢ Tracking ID: ${item.tracking_id} | ğŸš˜ Loáº¡i xe: <b>${vehicleType}</b><br/>
          ğŸªª Biá»ƒn sá»‘: <b>${item.plate_number}</b><br/>
          <img src="${item.image_link}" class="log-img" style="width: 80%;"/>
          <hr/>
        `;
        container.appendChild(div);
      });
    })
    .catch(err => {
      console.error("Lá»—i khi tÃ¬m kiáº¿m:", err);
    });
}

// Hiá»ƒn thá»‹ máº·c Ä‘á»‹nh tab live
showTab('live');
</script>
</body>
</html>
